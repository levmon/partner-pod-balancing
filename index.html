<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coaching Forest Visualization</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: stretch; 
            background-color: #f4f4f4;
        }
        h1 {
            color: #333;
        }
        .tree-container {
            border: 1px solid #ccc;
            margin-bottom: 20px;
            background-color: #fff;
            width: 95%; 
            height: 85vh; 
            overflow: hidden; 
        }
        #coaching-tree-svg { 
            width: 100%;
            height: 100%;
        }
        .node circle {
            fill: #fff;
            stroke: steelblue;
            stroke-width: 3px;
            cursor: pointer;
        }
        .node text {
            font: 12px sans-serif;
            cursor: pointer;
        }
        .node .node-text-name {
            font-weight: bold;
        }
        .node .node-text-id {
            font-size: 10px;
            fill: #777;
        }
        .link {
            fill: none;
            stroke: #ccc;
            stroke-width: 2px;
        }
        #metadata-tooltip {
            position: absolute;
            text-align: left;
            padding: 8px;
            font: 12px sans-serif;
            background: lightsteelblue;
            border: 0px;
            border-radius: 8px;
            pointer-events: none;
            opacity: 0;
            white-space: pre-wrap; 
        }
        .controls {
            display: flex; 
            flex-wrap: wrap; 
            align-items: center; 
            margin-bottom: 20px;
            padding: 10px;
            background-color: #eee;
            border-radius: 5px;
            width: 95%; 
            box-sizing: border-box; 
        }
        .controls label {
            margin-right: 5px;
        }
        .controls select, .controls button {
            padding: 5px;
            margin-right: 10px;
        }
        .controls label, .controls select, .controls button { 
            margin-right: 10px; 
        }
        /* Tab styling */
        .tab-buttons {
            position: -webkit-sticky; /* For Safari */
            position: sticky;
            top: 0;
            z-index: 100; /* Ensure it stays on top */
            overflow: hidden;
            border: 1px solid #ccc;
            background-color: #f1f1f1;
            margin-bottom: 10px;
        }
        .tab-buttons button {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            transition: 0.3s;
            font-size: 17px;
        }
        .tab-buttons button:hover {
            background-color: #ddd;
        }
        .tab-buttons button.active {
            background-color: #ccc;
        }
        .tab-content {
            display: none; 
            padding: 6px 12px;
            border: 1px solid #ccc;
            border-top: none;
            width: 100%; 
            box-sizing: border-box;
        }
        #orphaned-table-container table {
            width: 100%;
            border-collapse: collapse;
        }
        #orphaned-table-container th, #orphaned-table-container td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        #orphaned-table-container th {
            background-color: #f2f2f2;
        }
        /* Modal styles */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgb(0,0,0); 
            background-color: rgba(0,0,0,0.4); 
            padding-top: 60px;
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto; 
            padding: 20px;
            border: 1px solid #888;
            width: 450px; 
            max-width: 90%;
            border-radius: 8px;
        }
        .modal-content label, .modal-content select, .modal-content button {
            margin-top: 10px;
            margin-bottom: 10px;
            display: block; 
        }
        .modal-content select {
             width: 100%; 
             box-sizing: border-box; 
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        #temp-moves-log-table th, #temp-moves-log-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        #temp-moves-log-table th {
            background-color: #f2f2f2;
        }
        .move-action-icon { 
            font-size: 10px;
            color: green;
        }
        /* Custom Context Menu Styles */
        .custom-context-menu {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            border: 1px solid #ccc;
            padding: 5px 0;
            z-index: 1001;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
            border-radius: 4px;
        }
        .custom-context-menu ul {
            list-style: none;
            margin: 0;
            padding: 0;
        }
        .custom-context-menu ul li {
            padding: 8px 15px;
            cursor: pointer;
            font-size: 14px;
        }
        .custom-context-menu ul li:hover {
            background-color: #eee;
        }
        /* Partner Pods Styles */
        .pod-container {
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
        }
        .bulk-move-button {
            margin-left: 20px;
            padding: 5px 10px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: none; /* Hidden by default */
        }
        .bulk-move-button:hover {
            background-color: #218838;
        }
        .pod-header {
            display: flex;
            align-items: center;
            font-weight: bold;
            font-size: 1.2em;
            cursor: pointer;
            padding: 5px;
            background-color: #f0f0f0;
            border-radius: 3px;
        }
        .pod-header:hover {
            background-color: #e0e0e0;
        }
        .pod-content {
            display: none; /* Hidden by default */
            padding-left: 15px;
            border-top: 1px solid #eee;
            margin-top: 5px;
        }
        .pod-table {
            width: 100%;
            max-width: 850px; /* Stop table from stretching too wide */
            border-collapse: collapse;
            margin-top: 10px;
        }
        .pod-table th, .pod-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .pod-table th {
            background-color: #f2f2f2;
        }
        .pod-member-different-location {
            background-color: #e6ccff; /* A darker purple background for the row */
        }
        .pod-member-different-offering {
            color: #b5651d; /* An amber/brown color */
            font-weight: bold;
        }
        .coaching-tree-mismatch {
            color: #d9534f; /* A red color for the icon */
            font-size: 1.2em;
            cursor: help;
        }
    </style>
</head>
<body>
    <h1>Coaching Forest</h1>

    <div class="tab-buttons">
        <button class="tab-button active" onclick="openTab(event, 'partnerTreesTab')">Partner Trees</button>
        <button class="tab-button" onclick="openTab(event, 'orphanedTnTTab')" id="orphanedTabButton">Orphaned</button>
        <button class="tab-button" onclick="openTab(event, 'partnerPodsTab')">Partner Pods</button>
        <button class="tab-button" onclick="openTab(event, 'podMovesLogTab')">Pod Moves Log</button>
        <button class="tab-button" onclick="openTab(event, 'tempMovesLogTab')" id="tempMovesLogTabButton">Temporary Moves Log</button>
    </div>

    <div class="controls" style="margin-top: 10px;"> 
        <label for="ou-selector">Select Operating Unit:</label>
        <select id="ou-selector"></select>
    </div>

    <!-- Tab content -->
    <div id="partnerTreesTab" class="tab-content" style="display:block;">
        <div class="controls">
            <label for="tree-selector">Select Partner Tree:</label>
            <select id="tree-selector"></select>
            <button id="reset-zoom">Reset Zoom/Pan</button>
        </div>
        <div id="chart-container" class="tree-container">
            <svg id="coaching-tree-svg"></svg>
        </div>
    </div>

    <div id="orphanedTnTTab" class="tab-content" style="display:none;">
        <h2 id="orphaned-title">Orphaned Employees Report</h2>
        <p id="orphaned-description">This report shows employees from the selected Operating Unit (if applicable for this report type) who meet specific criteria (e.g., non-Partners whose coach is outside their unit, invalid, or missing).</p>
        <div id="orphaned-table-container">
            <!-- Table will be generated here by D3 -->
        </div>
    </div>

    <div id="tempMovesLogTab" class="tab-content" style="display:none;">
        <h2>Temporary Moves Log</h2>
        <p><em>These changes are temporary and reflect 'what-if' scenarios. They will be reset when the underlying data is refreshed (i.e., when <code>build_forest.py</code> is re-run). To make permanent organizational changes, please update the source Excel file.</em></p>
        <button id="clear-temp-moves-button" style="margin-bottom: 15px;">Clear All Temporary Moves</button>
        <div id="temp-moves-log-table-container">
            <table id="temp-moves-log-table" style="width:100%; border-collapse: collapse;">
                <thead>
                    <tr>
                        <th>Moved Employee</th>
                        <th>Moved Employee ID</th>
                        <th>Original Coach</th>
                        <th>New Coach</th>
                        <th>Timestamp</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Log entries will be populated here by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <div id="partnerPodsTab" class="tab-content" style="display:none;">
        <h2 id="pods-title">Partner Pods</h2>
        <p id="pods-description">This view shows non-hierarchical groupings of employees based on their direct relationship to a Partner.</p>
        <div id="pods-container">
            <!-- Pods will be generated here by D3 -->
        </div>
    </div>

    <div id="podMovesLogTab" class="tab-content" style="display:none;">
        <h2>Partner Pod Moves Log</h2>
        <p><em>These changes are temporary and reflect 'what-if' scenarios for pod relationships.</em></p>
        <button id="clear-pod-moves-button" style="margin-bottom: 15px;">Clear All Pod Moves</button>
        <div id="pod-moves-log-table-container">
            <table id="pod-moves-log-table" style="width:100%; border-collapse: collapse;">
                <thead>
                    <tr>
                        <th>Moved Employee</th>
                        <th>Original Pod Partner</th>
                        <th>New Pod Partner</th>
                        <th>Timestamp</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Log entries will be populated here by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- The Modal for Moving an Employee -->
    <div id="moveEmployeeModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeMoveModal">&times;</span>
            <h3 id="moveModalTitle">Move Employee</h3>
            <p id="moveEmployeeInfo"></p>
            <div>
                <label for="newPartnerSelector">Select New Partner (Coach):</label>
                <select id="newPartnerSelector"></select>
            </div>
            <button id="confirmMoveButton" style="margin-top: 20px;">Confirm Move</button>
            <button id="cancelMoveButton" style="margin-left: 10px;">Cancel</button>
        </div>
    </div>

    <!-- The Modal for Moving a Pod Member -->
    <div id="movePodMemberModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeMovePodModal">&times;</span>
            <h3 id="movePodModalTitle">Move Pod Member</h3>
            <p id="movePodMemberInfo"></p>
            <div>
                <label for="newPodPartnerSelector">Select New Pod Partner:</label>
                <select id="newPodPartnerSelector"></select>
            </div>
            <button id="confirmPodMoveButton" style="margin-top: 20px;">Confirm Move</button>
            <button id="cancelPodMoveButton" style="margin-left: 10px;">Cancel</button>
        </div>
    </div>

    <div id="metadata-tooltip"></div>

    <!-- Custom Context Menu HTML -->
    <div id="customContextMenu" class="custom-context-menu">
        <ul>
            <li id="contextMenuMoveItem">Move Employee...</li>
        </ul>
    </div>

    <script>
        const margin = { top: 20, right: 120, bottom: 20, left: 120 };
        let svg, g, zoom, currentGlobalPartnerTrees, currentOrphanedReport, currentRoot, treeLayout, currentRootPartnerLocation, currentSelectedOU;
        let i = 0; 
        const duration = 750; 

        // --- Variables for Move Employee Feature ---
        let moveEmployeeModal, closeMoveModalButton, confirmMoveButton, cancelMoveButton, newPartnerSelector, moveModalTitle, moveEmployeeInfo;
        let currentEmployeeToMoveD3Node = null; 
        let changeLog = [];
        let podChangeLog = [];
        const LOCAL_STORAGE_KEY_MOVES = 'coachingForestMovesLog';
        const LOCAL_STORAGE_KEY_POD_MOVES = 'coachingForestPodMovesLog';
        const PARTNER_LEVEL_VALUE = 'Partner';

        // --- DOM Elements for Move Employee Feature & Context Menu ---
        let tempMovesLogTableBody, clearTempMovesButton;
        let customContextMenu, contextMenuMoveItem;
        let contextMenuTargetNode = null;

        // --- Variables for Move Pod Member Feature ---
        let movePodMemberModal, closeMovePodModalButton, confirmPodMoveButton, cancelPodMoveButton, newPodPartnerSelector, movePodModalTitle, movePodMemberInfo;
        let currentEmployeeToMovePod = null;

        // --- Style Configuration ---
        const config = {
            colors: {
                link: "#ccc", 
                nodeStrokeSameLocation: "steelblue", 
                nodeStrokeDifferentLocation: "purple", 
                nodeFillSameOU: "#fff",       
                nodeFillDifferentOU: "orange" 
            }
        };
        // --- End Style Configuration ---

        const tooltip = d3.select("#metadata-tooltip");

        // Prepare SVG and main group element
        function setupSvg() {
            d3.select("#coaching-tree-svg").selectAll("*").remove();
            svg = d3.select("#coaching-tree-svg"); 
            g = svg.append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);
            zoom = d3.zoom()
                .scaleExtent([0.1, 3]) 
                .on("zoom", (event) => {
                    g.attr("transform", event.transform);
                });
            svg.call(zoom);
            d3.select("#reset-zoom").on("click", () => {
                svg.transition().duration(750).call(
                    zoom.transform,
                    d3.zoomIdentity.translate(margin.left, margin.top).scale(1)
                );
            });
        }

        // Load data and initialize visualization
        d3.json("forest.json?" + new Date().getTime()).then(async function(data) { 
            // --- Initialize Coach Move Elements ---
            moveEmployeeModal = document.getElementById('moveEmployeeModal');
            const coachMoveCloseButton = moveEmployeeModal.querySelector('.close-button');
            const coachMoveConfirmButton = moveEmployeeModal.querySelector('#confirmMoveButton');
            const coachMoveCancelButton = moveEmployeeModal.querySelector('#cancelMoveButton');
            newPartnerSelector = document.getElementById('newPartnerSelector');
            moveModalTitle = document.getElementById('moveModalTitle');
            moveEmployeeInfo = document.getElementById('moveEmployeeInfo');
            tempMovesLogTableBody = document.querySelector("#temp-moves-log-table tbody");
            clearTempMovesButton = document.getElementById('clear-temp-moves-button');
            customContextMenu = document.getElementById('customContextMenu');
            contextMenuMoveItem = document.getElementById('contextMenuMoveItem');

            // --- Initialize Pod Move Elements ---
            movePodMemberModal = document.getElementById('movePodMemberModal');
            const podMoveCloseButton = movePodMemberModal.querySelector('.close-button');
            const podMoveConfirmButton = movePodMemberModal.querySelector('#confirmPodMoveButton');
            const podMoveCancelButton = movePodMemberModal.querySelector('#cancelPodMoveButton');
            newPodPartnerSelector = document.getElementById('newPodPartnerSelector');
            movePodModalTitle = document.getElementById('movePodModalTitle');
            movePodMemberInfo = document.getElementById('movePodMemberInfo');
            
            // --- Assign Event Listeners ---
            coachMoveCloseButton.onclick = () => { moveEmployeeModal.style.display = "none"; };
            coachMoveCancelButton.onclick = () => { moveEmployeeModal.style.display = "none"; };
            coachMoveConfirmButton.onclick = confirmMove; 
            clearTempMovesButton.onclick = clearTemporaryMoves; 

            podMoveCloseButton.onclick = () => { movePodMemberModal.style.display = "none"; };
            podMoveCancelButton.onclick = () => { movePodMemberModal.style.display = "none"; };
            podMoveConfirmButton.onclick = confirmPodMove;
            document.getElementById('clear-pod-moves-button').onclick = clearPodMoves;

            contextMenuMoveItem.onclick = function() {
                if (contextMenuTargetNode) {
                    showMoveEmployeeModal(contextMenuTargetNode);
                }
                customContextMenu.style.display = 'none';
                contextMenuTargetNode = null;
            };

            window.addEventListener('click', function(event) { 
                customContextMenu.style.display = 'none';
                contextMenuTargetNode = null;
                if (event.target == moveEmployeeModal) {
                    moveEmployeeModal.style.display = "none";
                }
                 if (event.target == movePodMemberModal) {
                    movePodMemberModal.style.display = "none";
                }
            });
             window.addEventListener('keydown', function(event) { 
                if (event.key === 'Escape') {
                    customContextMenu.style.display = 'none';
                    contextMenuTargetNode = null;
                }
            });

            // --- Load Data ---
            if (!data || !data.all_partner_trees || data.all_partner_trees.length === 0) {
                console.error("No 'all_partner_trees' data found in forest.json or it is empty.");
                d3.select("#chart-container").text("Error: No Partner tree data to display. Check forest.json.");
                currentOrphanedReport = (data && data.all_orphaned_employees) ? data.all_orphaned_employees : [];
            } else {
                 currentGlobalPartnerTrees = (data && data.all_partner_trees) ? data.all_partner_trees : [];
                 currentOrphanedReport = (data && data.all_orphaned_employees) ? data.all_orphaned_employees : [];
            }

            // --- Apply Changes and Render ---
            loadChangeLog();
            loadPodChangeLog();
            applyLoggedChanges();
            applyPodLoggedChanges();

            populateOUSelector(currentGlobalPartnerTrees); 
            currentSelectedOU = d3.select("#ou-selector").property("value"); 
            filterAndDisplayData(); 

            updateOrphanedReportDisplay();
            const allEmployeesForPods = getUniqueEmployees();
            renderPartnerPods(allEmployeesForPods, currentGlobalPartnerTrees);
            renderChangeLogTable();
            renderPodChangeLogTable();

            d3.select("#ou-selector").on("change", function() {
                currentSelectedOU = d3.select(this).property("value");
                filterAndDisplayData();
                updateOrphanedReportDisplay();
                const allEmployeesForPods = getUniqueEmployees();
                renderPartnerPods(allEmployeesForPods, currentGlobalPartnerTrees);
            });
            
            d3.select("#tree-selector").on("change", function() {
                const selectedTreeId = d3.select(this).property("value");
                const selectedPartnerData = findNodeById(currentGlobalPartnerTrees, selectedTreeId); 
                if (selectedPartnerData && selectedPartnerData['Operating Unit Name'] === currentSelectedOU) {
                    loadTree(selectedPartnerData);
                } else if (currentGlobalPartnerTrees.find(p => p.id === selectedTreeId && p['Operating Unit Name'] === currentSelectedOU)) {
                     loadTree(currentGlobalPartnerTrees.find(p => p.id === selectedTreeId && p['Operating Unit Name'] === currentSelectedOU));
                }
            });

        }).catch(function(error) {
            console.error("Error loading or processing forest.json:", error);
            d3.select("#partnerTreesTab").html("Error loading forest.json. See console for details.");
            d3.select("#orphanedTnTTab").html("Error loading forest.json. See console for details.");
            d3.select("#tempMovesLogTab").html("Error loading forest.json. See console for details.");
        });

        function openTab(evt, tabName) {
            let i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tab-button");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }

        function renderOrphanedReportTable(orphanedData) {
            const container = d3.select("#orphaned-table-container");
            container.selectAll("*").remove(); 

            if (!orphanedData || orphanedData.length === 0) {
                container.append("p").text("No employees found for this report based on the current data.");
                return;
            }

            const table = container.append("table");
            const thead = table.append("thead");
            const tbody = table.append("tbody");

            const columns = [
                { key: 'id', label: 'Employee ID' },
                { key: 'name', label: 'Name' },
                { key: 'level', label: 'Level' },
                { key: 'Operating Unit Name', label: 'Operating Unit' }, 
                { key: 'coach_id', label: 'Listed Coach ID' },
                { key: 'reason_for_listing', label: 'Reason' }
            ];

            thead.append("tr")
                .selectAll("th")
                .data(columns)
                .enter()
                .append("th")
                .text(d => d.label);

            const rows = tbody.selectAll("tr")
                .data(orphanedData)
                .enter()
                .append("tr");

            rows.selectAll("td")
                .data(d_row => { 
                    return columns.map(col => {
                        return { column: col.key, value: d_row[col.key] || "N/A" };
                    });
                })
                .enter()
                .append("td")
                .text(d_cell => d_cell.value);
        }

        function populateOUSelector(allPartnerData) {
            const ouSelector = d3.select("#ou-selector");
            const operatingUnits = new Set();
            allPartnerData.forEach(partner => {
                if (partner['Operating Unit Name']) {
                    operatingUnits.add(partner['Operating Unit Name']);
                }
            });

            ouSelector.selectAll("option").remove(); 

            const sortedOperatingUnits = Array.from(operatingUnits).sort();

            sortedOperatingUnits.forEach(ou => {
                ouSelector.append("option")
                    .attr("value", ou)
                    .text(ou);
            });

            if (sortedOperatingUnits.length > 0) {
                if (operatingUnits.has("T&T Artificial Intelligence & Data")) {
                    ouSelector.property("value", "T&T Artificial Intelligence & Data");
                } else {
                    ouSelector.property("value", sortedOperatingUnits[0]); 
                }
            } else {
                 ouSelector.append("option").text("No Operating Units Found");
            }
            currentSelectedOU = ouSelector.property("value"); 
        }

        function filterAndDisplayData() {
            if (!currentSelectedOU) {
                d3.select("#tree-selector").html("<option>Select an Operating Unit</option>");
                d3.select("#chart-container").html('<p style="padding:20px;">Please select an Operating Unit to see partner trees.</p>');
                currentRoot = null;
                if (svg) g.selectAll("*").remove();
                return;
            }

            let filteredPartners = currentGlobalPartnerTrees.filter(partnerNode => 
                partnerNode['Operating Unit Name'] === currentSelectedOU && partnerNode.level === PARTNER_LEVEL_VALUE
            );

            filteredPartners.sort((a, b) => {
                const countA = typeof a.indirect_coachee_count !== 'undefined' ? a.indirect_coachee_count : -1;
                const countB = typeof b.indirect_coachee_count !== 'undefined' ? b.indirect_coachee_count : -1;
                return countB - countA;
            });

            if (filteredPartners.length === 0) {
                const message = `No Partners found for Operating Unit: ${currentSelectedOU}.`;
                console.warn(message);
                d3.select("#tree-selector").html(`<option>${message}</option>`);
                d3.select("#chart-container").html(`<p style="padding:20px;">${message}</p>`);
                currentRoot = null;
                if (svg) g.selectAll("*").remove();
            } else {
                populatePartnerSelector(filteredPartners);
                if (filteredPartners.length > 0) { 
                    loadTree(filteredPartners[0]);
                }
            }
        }

        function updateOrphanedReportDisplay() {
            const orphanedTabButton = d3.select("#orphanedTabButton");
            const orphanedTitle = d3.select("#orphaned-title");
            const orphanedDescription = d3.select("#orphaned-description");
            const container = d3.select("#orphaned-table-container");

            orphanedTabButton.text('Orphaned'); 

            if (!currentSelectedOU) {
                orphanedTitle.text('Orphaned Employees Report');
                orphanedDescription.text('Please select an Operating Unit to view its orphaned employees.');
                container.html(''); 
                return;
            }

            const filteredOrphans = currentOrphanedReport.filter(emp => emp['Operating Unit Name'] === currentSelectedOU);
            
            orphanedTitle.text(`Orphaned Employees Report (${currentSelectedOU})`);

            if (filteredOrphans.length > 0) {
                orphanedDescription.text(`This report shows non-Partner employees from ${currentSelectedOU} whose coach is missing, invalid, or outside their Operating Unit.`);
                renderOrphanedReportTable(filteredOrphans);
            } else {
                orphanedDescription.text(`No orphaned employees found for ${currentSelectedOU}.`);
                container.html(''); 
            }
        }

        function getPodSizes(allEmployees) {
            const podSizes = {};
            allEmployees.forEach(emp => {
                if (emp.partner_relationship_id) {
                    if (!podSizes[emp.partner_relationship_id]) {
                        podSizes[emp.partner_relationship_id] = 0;
                    }
                    podSizes[emp.partner_relationship_id]++;
                }
            });
            return podSizes;
        }

        function renderPartnerPods(allEmployees, allPartners) {
            const container = d3.select("#pods-container");
            container.selectAll("*").remove();

            if (!currentSelectedOU) {
                container.html('<p>Please select an Operating Unit to view Partner Pods.</p>');
                return;
            }

            const ouPartners = allPartners.filter(p => p['Operating Unit Name'] === currentSelectedOU);
            const ouPartnerIds = new Set(ouPartners.map(p => p.id));

            const pods = {};
            ouPartnerIds.forEach(id => pods[id] = []); // Initialize all pods for the OU

            const errors = [];

            allEmployees.forEach(emp => {
                const podId = emp.partner_relationship_id;
                const status = emp.pod_relationship_status;

                // Add to a pod if their partner is in the currently selected OU
                if ((status === 'valid' || status === 'warning_different_offering') && ouPartnerIds.has(podId)) {
                    pods[podId].push(emp);
                }

                // Add to the error list if they are FROM the current OU and have any non-valid status
                if (emp['Operating Unit Name'] === currentSelectedOU && status !== 'valid') {
                    errors.push(emp);
                }
            });

            ouPartners.sort((a, b) => (pods[b.id] || []).length - (pods[a.id] || []).length);

            ouPartners.forEach(partner => {
                const podMembers = pods[partner.id] || [];
                const podContainer = container.append('div').attr('class', 'pod-container');
                const header = podContainer.append('div').attr('class', 'pod-header');

                header.append('span')
                    .text(`${partner.name} (Pod Size: ${podMembers.length})`)
                    .on('click', function(event) {
                        event.stopPropagation();
                        const content = d3.select(this.parentNode.parentNode).select('.pod-content');
                        const isHidden = content.style('display') === 'none';
                        content.style('display', isHidden ? 'block' : 'none');
                    });
                
                const bulkMoveButton = header.append('button')
                    .attr('class', 'bulk-move-button')
                    .text('Bulk Move Selected')
                    .on('click', function(event) {
                        event.stopPropagation();
                        const selectedEmployees = [];
                        podContainer.selectAll('.pod-member-checkbox:checked').each(function(d) {
                            selectedEmployees.push(d);
                        });
                        if (selectedEmployees.length > 0) {
                            showMovePodModal(selectedEmployees);
                        } else {
                            alert("Please select at least one employee to move.");
                        }
                    });

                const podContent = podContainer.append('div').attr('class', 'pod-content');

                if (podMembers.length > 0) {
                    const levelSortOrder = ['Director', 'Senior Manager', 'Manager', 'Senior Consultant', 'Consultant', 'Senior Analyst', 'Analyst'];
                    podMembers.sort((a, b) => {
                        const levelA = levelSortOrder.indexOf(a.level);
                        const levelB = levelSortOrder.indexOf(b.level);
                        if (levelA === -1) return 1;
                        if (levelB === -1) return -1;
                        return levelA - levelB;
                    });

                    const table = podContent.append('table').attr('class', 'pod-table');
                    const thead = table.append('thead');
                    const tbody = table.append('tbody');

                    const headerRow = thead.append('tr');
                    headerRow.append('th').append('input')
                        .attr('type', 'checkbox')
                        .on('click', function() {
                            const isChecked = d3.select(this).property('checked');
                            podContainer.selectAll('.pod-member-checkbox').property('checked', isChecked).dispatch('change');
                        });
                    
                    headerRow.selectAll('th.col-header')
                        .data(['Level', 'Name', 'Talent Group', 'Offering', 'Location', 'Actions'])
                        .enter()
                        .append('th')
                        .attr('class', 'col-header')
                        .text(d => d);

                    podMembers.forEach(member => {
                        const row = tbody.append('tr');
                        
                        row.append('td').append('input')
                           .attr('type', 'checkbox')
                           .attr('class', 'pod-member-checkbox')
                           .datum(member) // Attach data to checkbox
                           .on('change', function() {
                                const checkedCount = podContainer.selectAll('.pod-member-checkbox:checked').size();
                                bulkMoveButton.style('display', checkedCount > 0 ? 'inline-block' : 'none');
                           });

                        const partnerLocation = partner['Location  Name'];
                        const memberLocation = member['Location  Name'];
                        if (partnerLocation && memberLocation && partnerLocation !== memberLocation) {
                            row.attr('class', 'pod-member-different-location');
                        }

                        row.append('td').text(member.level);
                        
                        let nameDisplay = member.name;
                        if (member.coaching_tree_partner_id && member.partner_relationship_id && member.coaching_tree_partner_id !== member.partner_relationship_id) {
                            nameDisplay += ` <span class="coaching-tree-mismatch" title="Coaching tree partner is different from pod partner.">üå≥</span>`;
                        }
                        const nameCell = row.append('td').html(nameDisplay).style('white-space', 'nowrap');
                        
                        row.append('td').text(member.talent_group || 'N/A');
                        
                        const offeringCell = row.append('td').text(member['Operating Unit Name'] || 'N/A');
                        const partnerOffering = partner['Operating Unit Name'];
                        const memberOffering = member['Operating Unit Name'];
                        if (partnerOffering && memberOffering && partnerOffering !== memberOffering) {
                            offeringCell.attr('class', 'pod-member-different-offering');
                        }

                        row.append('td').text(memberLocation || 'N/A');
                        row.append('td').append('button').text('Move').on('click', (event) => {
                            event.stopPropagation();
                            showMovePodModal([member]); // Pass as an array for consistency
                        });

                        nameCell.on("mouseover", function(event) {
                                showTooltip(event, member);
                            })
                            .on("mouseout", hideTooltip);
                    });
                }
            });

            if (errors.length > 0) {
                const errorContainer = container.append('div').attr('class', 'pod-container');
                const errorHeader = errorContainer.append('div')
                    .attr('class', 'pod-header')
                    .on('click', function() {
                        const content = d3.select(this.parentNode).select('.pod-content');
                        const isHidden = content.style('display') === 'none';
                        content.style('display', isHidden ? 'block' : 'none');
                    });

                errorHeader.append('span')
                    .text(`Pod Relationship Errors in ${currentSelectedOU} (${errors.length})`);

                const bulkMoveButton = errorHeader.append('button')
                    .attr('class', 'bulk-move-button')
                    .text('Bulk Move Selected')
                    .on('click', function(event) {
                        event.stopPropagation();
                        const selectedEmployees = [];
                        errorContainer.selectAll('.pod-member-checkbox:checked').each(function(d) {
                            selectedEmployees.push(d);
                        });
                        if (selectedEmployees.length > 0) {
                            showMovePodModal(selectedEmployees);
                        } else {
                            alert("Please select at least one employee to move.");
                        }
                    });

                const errorContent = errorContainer.append('div').attr('class', 'pod-content');
                const errorTable = errorContent.append('table').attr('class', 'pod-table');
                
                const errorThead = errorTable.append('thead').append('tr');
                errorThead.append('th').append('input')
                    .attr('type', 'checkbox')
                    .on('click', function() {
                        const isChecked = d3.select(this).property('checked');
                        errorContainer.selectAll('.pod-member-checkbox').property('checked', isChecked).dispatch('change');
                    });

                errorThead.selectAll('th.col-header')
                    .data(['Name', 'Level', 'Talent Group', 'Offering', 'Location', 'Reason', 'Actions'])
                    .enter().append('th').attr('class', 'col-header').text(d => d);

                const errorTbody = errorTable.append('tbody');
                errors.forEach(emp => {
                    let reason = 'Unknown';
                    if (emp.pod_relationship_status === 'error_invalid_id') {
                        reason = `Invalid Partner (${emp.partner_relationship_name || emp.partner_relationship_id || 'N/A'})`;
                    } else if (emp.pod_relationship_status === 'warning_different_offering') {
                        const podPartner = findNodeById(currentGlobalPartnerTrees, emp.partner_relationship_id);
                        const partnerName = podPartner ? podPartner.name : (emp.partner_relationship_name || 'Unknown');
                        const partnerOffering = podPartner ? podPartner['Operating Unit Name'] : 'Unknown';
                        reason = `Partner (${partnerName}) is in different Offering (${partnerOffering})`;
                    }
                    const row = errorTbody.append('tr');

                    row.append('td').append('input')
                        .attr('type', 'checkbox')
                        .attr('class', 'pod-member-checkbox')
                        .datum(emp)
                        .on('change', function() {
                            const checkedCount = errorContainer.selectAll('.pod-member-checkbox:checked').size();
                            bulkMoveButton.style('display', checkedCount > 0 ? 'inline-block' : 'none');
                        });

                    row.append('td').text(emp.name);
                    row.append('td').text(emp.level);
                    row.append('td').text(emp.talent_group || 'N/A');
                    row.append('td').text(emp['Operating Unit Name'] || 'N/A');
                    row.append('td').text(emp['Location  Name'] || 'N/A');
                    row.append('td').text(reason);
                    row.append('td').append('button').text('Move').on('click', (event) => {
                        event.stopPropagation();
                        showMovePodModal([emp]);
                    });
                });
            }
        }

        function populatePartnerSelector(partnerTreeData) {
            const selector = d3.select("#tree-selector");
            selector.selectAll("option").remove();
            
            if (!partnerTreeData || partnerTreeData.length === 0) {
                const message = `No Partners found for ${currentSelectedOU}.`;
                selector.append("option").text(message);
                return;
            }

            selector.selectAll("option") 
                .data(partnerTreeData)
                .enter()
                .append("option")
                .attr("value", d => d.id)
                .text(d => {
                    const name = d.name || d.id;
                    const coacheeCount = typeof d.indirect_coachee_count !== 'undefined' ? d.indirect_coachee_count : 'N/A';
                    return `${name} (Pod Size: ${coacheeCount})`;
                });
        }

        function loadTree(treeData) {
            setupSvg(); 
            i = 0; 

            currentRoot = d3.hierarchy(treeData, d => d.children);
            currentRootPartnerLocation = currentRoot.data['Location  Name']; 

            const svgNode = svg.node(); 
            const effectiveHeight = svgNode.clientHeight > 0 ? svgNode.clientHeight : 600; 
            currentRoot.x0 = effectiveHeight / 2; 
            currentRoot.y0 = 0;

            update(currentRoot); 
        }

        function update(source) {
            const svgNode = svg.node();
            const currentSvgWidth = svgNode.clientWidth;
            const currentSvgHeight = svgNode.clientHeight;

            const availableWidth = currentSvgWidth - margin.left - margin.right;
            const availableHeight = currentSvgHeight - margin.top - margin.bottom;
            
            const treeHorizontalSpread = calculateDynamicWidth(currentRoot);
            
            treeLayout = d3.tree()
                .size([availableHeight > 0 ? availableHeight : 600, treeHorizontalSpread]) 
                .separation((a, b) => a.parent == b.parent ? 1.5 : 2); 
            const treeData = treeLayout(currentRoot);

            const nodes = treeData.descendants();
            const links = treeData.descendants().slice(1);

            const nodeDepthSpacing = 250; 
            nodes.forEach(d => { d.y = d.depth * nodeDepthSpacing;});

            const node = g.selectAll("g.node")
                .data(nodes, d => d.id || (d.id = ++i));

            const nodeEnter = node.enter().append("g")
                .attr("class", "node")
                .attr("transform", d => `translate(${source.y0},${source.x0})`)
                .on("click", (event, d) => { 
                    customContextMenu.style.display = 'none'; 
                    contextMenuTargetNode = null;
                    if (d.children || d._children) { 
                        toggle(d);
                        update(d);
                    }
                })
                .on("contextmenu", function(event, d) { 
                    event.preventDefault();
                    customContextMenu.style.display = 'none'; 
                    contextMenuTargetNode = null;

                    if (d.data.level !== PARTNER_LEVEL_VALUE) {
                        contextMenuTargetNode = d; 
                        customContextMenu.style.left = event.pageX + 'px';
                        customContextMenu.style.top = event.pageY + 'px';
                        customContextMenu.style.display = 'block';
                    }
                })
                .on("mouseover", function(event, d) {
                    showTooltip(event, d.data);
                })
                .on("mouseout", hideTooltip);

            nodeEnter.append("circle")
                .attr("r", 1e-6)
                .style("fill", d => {
                    const nodeOU = d.data['Operating Unit Name'];
                    const rootOU = currentRoot && currentRoot.data ? currentRoot.data['Operating Unit Name'] : null;
                    if (rootOU && nodeOU && nodeOU !== rootOU) {
                        return config.colors.nodeFillDifferentOU; 
                    }
                    return config.colors.nodeFillSameOU; 
                })
                .style("stroke", d => {
                    const isSameLocation = currentRootPartnerLocation && d.data['Location  Name'] === currentRootPartnerLocation;
                    if (currentRootPartnerLocation && !isSameLocation) {
                        return config.colors.nodeStrokeDifferentLocation;
                    }
                    return config.colors.nodeStrokeSameLocation;
                })
                .style("stroke-width", "3px");

            nodeEnter.append("text")
                .attr("dy", ".35em")
                .attr("x", d => d.children || d._children ? -13 : 13)
                .attr("text-anchor", d => d.children || d._children ? "end" : "start")
                .html(d => {
                    const name = d.data.name || d.data.id || "Unknown";
                    const level = d.data.level || "N/A";
                    const location = d.data['Location  Name'] || "N/A";
                    const isPartner = d.data.level === PARTNER_LEVEL_VALUE;
                    const indirectCoachees = d.data.indirect_coachee_count;
                    const xPos = d.children || d._children ? -13 : 13;
                    const defaultFillStyle = "black"; 

                    let nameStyle = `fill:${defaultFillStyle}`; 
                    if (d.data.hasOwnProperty('direct_coachee_count') && d.data.hasOwnProperty('FTE')) {
                        const directCoachees = parseInt(d.data.direct_coachee_count, 10);
                        const fteValue = parseFloat(d.data.FTE);
                        if (!isNaN(directCoachees) && !isNaN(fteValue) && fteValue > 0) { 
                            if (directCoachees > (5 * fteValue)) {
                                nameStyle = "font-weight: bold; fill: red;";
                            }
                        }
                    }
                    
                    let movedIcon = "";
                    if (changeLog.some(log => log.moved_employee_id === d.data.id)) {
                        movedIcon = ' <tspan class="move-action-icon">‚ÜîÔ∏è</tspan>';
                    }

                    let htmlString = `<tspan class="node-text-name" style="${nameStyle}" x="${xPos}" dy="0em">${name}${movedIcon}</tspan>` +
                                     `<tspan class="node-text-details" style="fill:${defaultFillStyle}" x="${xPos}" dy="1.2em">${level}</tspan>` +
                                     `<tspan class="node-text-details" style="fill:${defaultFillStyle}" x="${xPos}" dy="1.2em">${location}</tspan>`;
                    
                    if (isPartner && typeof indirectCoachees !== 'undefined') {
                        htmlString += `<tspan class="node-text-details" style="fill:${defaultFillStyle}" x="${xPos}" dy="1.2em">Pod Size: ${indirectCoachees}</tspan>`;
                    }
                    return htmlString;
                });

            const nodeUpdate = nodeEnter.merge(node);

            nodeUpdate.transition()
                .duration(duration)
                .attr("transform", d => `translate(${d.y},${d.x})`);

            nodeUpdate.select("circle")
                .attr("r", 10)
                .style("fill", d => { 
                    const nodeOU = d.data['Operating Unit Name'];
                    const rootOU = currentRoot && currentRoot.data ? currentRoot.data['Operating Unit Name'] : null;
                    if (rootOU && nodeOU && nodeOU !== rootOU) {
                        return config.colors.nodeFillDifferentOU; 
                    }
                    return config.colors.nodeFillSameOU; 
                })
                .style("stroke", d => { 
                    const isSameLocation = currentRootPartnerLocation && d.data['Location  Name'] === currentRootPartnerLocation;
                    if (currentRootPartnerLocation && !isSameLocation) {
                        return config.colors.nodeStrokeDifferentLocation;
                    }
                    return config.colors.nodeStrokeSameLocation;
                })
                .style("stroke-width", "3px")
                .attr("cursor", "pointer");

            nodeUpdate.select("text").html(d => { 
                    const name = d.data.name || d.data.id || "Unknown";
                    const level = d.data.level || "N/A";
                    const location = d.data['Location  Name'] || "N/A";
                    const isPartner = d.data.level === PARTNER_LEVEL_VALUE;
                    const indirectCoachees = d.data.indirect_coachee_count;
                    const xPos = d.children || d._children ? -13 : 13;
                    const defaultFillStyle = "black"; 

                    let nameStyle = `fill:${defaultFillStyle}`; 
                    if (d.data.hasOwnProperty('direct_coachee_count') && d.data.hasOwnProperty('FTE')) {
                        const directCoachees = parseInt(d.data.direct_coachee_count, 10);
                        const fteValue = parseFloat(d.data.FTE);
                         if (!isNaN(directCoachees) && !isNaN(fteValue) && fteValue > 0) { 
                            if (directCoachees > (5 * fteValue)) {
                                nameStyle = "font-weight: bold; fill: red;";
                            }
                        }
                    }

                    let movedIcon = "";
                    if (changeLog.some(log => log.moved_employee_id === d.data.id)) {
                        movedIcon = ' <tspan class="move-action-icon">‚ÜîÔ∏è</tspan>';
                    }

                    let htmlString = `<tspan class="node-text-name" style="${nameStyle}" x="${xPos}" dy="0em">${name}${movedIcon}</tspan>` +
                                     `<tspan class="node-text-details" style="fill:${defaultFillStyle}" x="${xPos}" dy="1.2em">${level}</tspan>` +
                                     `<tspan class="node-text-details" style="fill:${defaultFillStyle}" x="${xPos}" dy="1.2em">${location}</tspan>`;
                    
                    if (isPartner && typeof indirectCoachees !== 'undefined') {
                        htmlString += `<tspan class="node-text-details" style="fill:${defaultFillStyle}" x="${xPos}" dy="1.2em">Pod Size: ${indirectCoachees}</tspan>`;
                    }
                    return htmlString;
            });

            const nodeExit = node.exit().transition()
                .duration(duration)
                .attr("transform", d => `translate(${source.y},${source.x})`)
                .remove();

            nodeExit.select("circle").attr("r", 1e-6);
            nodeExit.select("text").style("fill-opacity", 1e-6);

            const link = g.selectAll("path.link")
                .data(links, d => d.id);

            const linkEnter = link.enter().insert("path", "g")
                .attr("class", "link")
                .style("stroke", config.colors.link)
                .attr("d", d => {
                    const o = {x: source.x0, y: source.y0};
                    return diagonal(o, o);
                });

            const linkUpdate = linkEnter.merge(link);

            linkUpdate.transition()
                .duration(duration)
                .style("stroke", config.colors.link)
                .attr("d", d => diagonal(d, d.parent));

            link.exit().transition()
                .duration(duration)
                .attr("d", d => {
                    const o = {x: source.x, y: source.y};
                    return diagonal(o, o);
                })
                .remove();

            nodes.forEach(d => {
                d.x0 = d.x;
                d.y0 = d.y;
            });
        }

        function toggle(d) {
            if (d.children) { 
                d._children = d.children; 
                d.children = null;       
            } else { 
                d.children = d.children || d._children; 
                d._children = null;      
            }
        }

        function collapse(d) { 
            if (d.children) {
                d._children = d.children;
                d._children.forEach(collapse); 
                d.children = null;
            }
        }
        
        function diagonal(s, d) {
            const path = `M ${s.y} ${s.x}
                        C ${(s.y + d.y) / 2} ${s.x},
                          ${(s.y + d.y) / 2} ${d.x},
                          ${d.y} ${d.x}`;
            return path;
        }

        function calculateDynamicWidth(root) {
            if (!root) { 
                 const svgNode = svg.node(); 
                 if (svgNode && svgNode.clientWidth > 0) return svgNode.clientWidth - margin.left - margin.right;
                 return 1000; 
            }
            let maxD = 0;
            root.each(d => { if (d.depth > maxD) maxD = d.depth; });
            return (maxD + 1) * 280; 
        }

        function getUniqueEmployees() {
            const allEmployeesMap = new Map();
            // The tree contains the most up-to-date data after moves, so process it first.
            flattenTree(currentGlobalPartnerTrees).forEach(emp => allEmployeesMap.set(emp.id, emp));
            // Then add any orphans who might not be in a tree (e.g. coach_id points to non-existent employee)
            currentOrphanedReport.forEach(emp => {
                if (!allEmployeesMap.has(emp.id)) {
                    allEmployeesMap.set(emp.id, emp);
                }
            });
            return Array.from(allEmployeesMap.values());
        }

        function flattenTree(nodes) {
            let flat = [];
            function recurse(node) {
                flat.push(node.data ? node.data : node);
                if (node.children) {
                    node.children.forEach(recurse);
                }
            }
            nodes.forEach(recurse);
            return flat;
        }

        function showTooltip(event, d) {
            const allNodes = [...flattenTree(currentGlobalPartnerTrees), ...currentOrphanedReport];
            const coach = d.coach_id ? allNodes.find(n => n.id === d.coach_id) : null;
            const coachName = coach ? coach.name : 'N/A';
            const coachingTreePartner = d.coaching_tree_partner_id ? allNodes.find(n => n.id === d.coaching_tree_partner_id) : null;
            const coachingTreePartnerName = coachingTreePartner ? coachingTreePartner.name : 'N/A';

            let tooltipText = `Name: ${d.name || 'N/A'}
Level: ${d.level || 'N/A'}
Location: ${d['Location  Name'] || 'N/A'}
Offering: ${d['Operating Unit Name'] || 'N/A'}
Talent Group: ${d.talent_group || 'N/A'}
Coach: ${coachName}
Coaching Tree: ${coachingTreePartnerName}
Direct Reports: ${d.direct_coachee_count !== undefined ? d.direct_coachee_count : 'N/A'}`;

            tooltip.transition().duration(200).style("opacity", .9);
            tooltip.html(tooltipText)
                .style("left", (event.pageX + 15) + "px")
                .style("top", (event.pageY - 28) + "px");
        }

        function hideTooltip() {
            tooltip.transition().duration(500).style("opacity", 0);
        }

        // --- Functions for Move Pod Member Feature ---

        function showMovePodModal(employeesToMove) {
            currentEmployeeToMovePod = employeesToMove; // This now holds an array

            if (employeesToMove.length === 1) {
                movePodModalTitle.textContent = `Move Pod Member: ${employeesToMove[0].name}`;
                movePodMemberInfo.textContent = `ID: ${employeesToMove[0].id}, Current Pod: ${employeesToMove[0].partner_relationship_name || 'N/A'}`;
            } else {
                movePodModalTitle.textContent = `Bulk Move ${employeesToMove.length} Employees`;
                movePodMemberInfo.textContent = `Moving multiple employees to a new pod.`;
            }
            
            const firstEmployee = employeesToMove[0];
            const allEmployeesForPods = getUniqueEmployees();
            const ouPartners = currentGlobalPartnerTrees.filter(p => p['Operating Unit Name'] === currentSelectedOU);
            const ouPartnerIds = new Set(ouPartners.map(p => p.id));
            const unassignedList = allEmployeesForPods.filter(emp => {
                const podId = emp.partner_relationship_id;
                return emp['Operating Unit Name'] === currentSelectedOU && emp.level !== PARTNER_LEVEL_VALUE && (podId ? !ouPartnerIds.has(podId) || !emp.is_pod_relationship_valid : true);
            });
            const isUnassigned = unassignedList.some(e => e.id === firstEmployee.id);
            
            const employeeOU = firstEmployee['Operating Unit Name'];
            const employeeLocation = firstEmployee['Location  Name'];

            const targetOU = isUnassigned ? employeeOU : currentSelectedOU;
            
            const eligiblePartners = currentGlobalPartnerTrees.filter(p => 
                p.level === PARTNER_LEVEL_VALUE &&
                p['Operating Unit Name'] === targetOU &&
                !employeesToMove.some(emp => emp.partner_relationship_id === p.id) // Ensure not moving to own pod
            );

            // Sort partners: same location first, then by name
            eligiblePartners.sort((a, b) => {
                const aSameLoc = a['Location  Name'] === employeeLocation;
                const bSameLoc = b['Location  Name'] === employeeLocation;
                if (aSameLoc && !bSameLoc) return -1;
                if (!aSameLoc && bSameLoc) return 1;
                return a.name.localeCompare(b.name);
            });

            newPodPartnerSelector.innerHTML = '<option value="">Select New Partner...</option>';
            const podSizes = getPodSizes(allEmployeesForPods);

            eligiblePartners.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                const podSize = podSizes[p.id] || 0;
                let text = `${p.name} (${p['Location  Name']}) - Pod Size: ${podSize}`;
                if (p['Location  Name'] !== employeeLocation) {
                    text += ' - Different Location';
                }
                option.textContent = text;
                newPodPartnerSelector.appendChild(option);
            });

            movePodMemberModal.style.display = "block";
        }

        function confirmPodMove() {
            const newPartnerId = newPodPartnerSelector.value;
            if (!currentEmployeeToMovePod || currentEmployeeToMovePod.length === 0 || !newPartnerId) {
                alert("Please select employee(s) and a new partner.");
                return;
            }

            const newPartner = findNodeById(currentGlobalPartnerTrees, newPartnerId);

            currentEmployeeToMovePod.forEach(employeeToMove => {
                const originalPartnerId = employeeToMove.partner_relationship_id;
                const originalPartner = originalPartnerId ? findNodeById(currentGlobalPartnerTrees, originalPartnerId) : null;

                // Update data in memory
                employeeToMove.partner_relationship_id = newPartner.id;
                employeeToMove.partner_relationship_name = newPartner.name;
                employeeToMove.is_pod_relationship_valid = true;
                employeeToMove.pod_relationship_status = 'valid'; // Explicitly mark as valid

                // Log the change
                podChangeLog.push({
                    moved_employee_id: employeeToMove.id,
                    moved_employee_name: employeeToMove.name,
                    original_partner_id: originalPartnerId,
                    original_partner_name: originalPartner ? originalPartner.name : 'N/A',
                    new_partner_id: newPartner.id,
                    new_partner_name: newPartner.name,
                    timestamp: new Date().toISOString()
                });
            });

            savePodChangeLog();
            renderPodChangeLogTable();
            
            // Re-render the pods view
            const allEmployeesForPods = getUniqueEmployees();
            renderPartnerPods(allEmployeesForPods, currentGlobalPartnerTrees);

            movePodMemberModal.style.display = "none";
        }

        function loadPodChangeLog() {
            const storedLog = localStorage.getItem(LOCAL_STORAGE_KEY_POD_MOVES);
            if (storedLog) {
                try {
                    podChangeLog = JSON.parse(storedLog);
                    if (!Array.isArray(podChangeLog)) podChangeLog = [];
                } catch (e) {
                    podChangeLog = [];
                }
            }
        }

        function savePodChangeLog() {
            localStorage.setItem(LOCAL_STORAGE_KEY_POD_MOVES, JSON.stringify(podChangeLog));
        }

        function applyPodLoggedChanges() {
            const allEmployees = getUniqueEmployees();
            podChangeLog.forEach(log => {
                const employee = allEmployees.find(e => e.id === log.moved_employee_id);
                if (employee) {
                    employee.partner_relationship_id = log.new_partner_id;
                    employee.partner_relationship_name = log.new_partner_name;
                    employee.is_pod_relationship_valid = true;
                    employee.pod_relationship_status = 'valid';
                }
            });
        }

        function renderPodChangeLogTable() {
            const tableBody = d3.select("#pod-moves-log-table tbody");
            tableBody.selectAll("*").remove();
            if (podChangeLog.length === 0) {
                tableBody.append('tr').append('td')
                    .attr('colspan', 4)
                    .style('text-align', 'center')
                    .text('No pod moves recorded.');
                return;
            }
            podChangeLog.forEach(log => {
                const row = tableBody.append('tr');
                row.append('td').text(log.moved_employee_name);
                row.append('td').text(log.original_partner_name);
                row.append('td').text(log.new_partner_name);
                row.append('td').text(new Date(log.timestamp).toLocaleString());
            });
        }

        function clearPodMoves() {
            if (confirm("Are you sure you want to clear all temporary pod moves?")) {
                podChangeLog = [];
                savePodChangeLog();
                window.location.reload();
            }
        }

        // --- Functions for Move Employee Feature ---

        function showMoveEmployeeModal(employeeD3Node) {
            console.log("Attempting to show move modal for:", employeeD3Node.data.name);
            currentEmployeeToMoveD3Node = employeeD3Node; 
            moveModalTitle.textContent = `Move Employee: ${employeeD3Node.data.name}`;
            moveEmployeeInfo.textContent = `ID: ${employeeD3Node.data.id}, Current OU: ${employeeD3Node.data['Operating Unit Name']}, Current Location: ${employeeD3Node.data['Location  Name']}`;
            populateNewPartnerSelector(employeeD3Node.data); 
            moveEmployeeModal.style.display = "block";
        }

        function populateNewPartnerSelector(employeeData) {
            console.log("Populating partner selector for employee:", employeeData.name);
            newPartnerSelector.innerHTML = '<option value="">Select New Partner...</option>'; 

            const employeeOU = employeeData['Operating Unit Name'];
            const employeeLocation = employeeData['Location  Name'];

            const eligiblePartners = currentGlobalPartnerTrees.filter(partnerNode => {
                return partnerNode.level === PARTNER_LEVEL_VALUE && 
                       partnerNode.id !== employeeData.coach_id && 
                       partnerNode.id !== employeeData.id && 
                       partnerNode['Operating Unit Name'] === employeeOU &&
                       partnerNode['Location  Name'] === employeeLocation;
            });

            eligiblePartners.forEach(partner => {
                const option = document.createElement('option');
                option.value = partner.id;
                
                const currentPartnerState = findNodeById(currentGlobalPartnerTrees, partner.id);
                const directCoachees = currentPartnerState ? (currentPartnerState.children ? currentPartnerState.children.length : 0) : (partner.children ? partner.children.length : 0);
                const indirectCoachees = currentPartnerState ? currentPartnerState.indirect_coachee_count : partner.indirect_coachee_count;

                option.textContent = `${partner.name} (Direct: ${directCoachees !== undefined ? directCoachees : 'N/A'}, Pod: ${indirectCoachees !== undefined ? indirectCoachees : 'N/A'})`;
                newPartnerSelector.appendChild(option);
            });
        }
        
        function findNodeById(roots, nodeId) {
            if (!nodeId) return null;
            for (let root of roots) {
                const found = findNodeRecursive(root, nodeId);
                if (found) return found;
            }
            return null;
        }

        function findNodeRecursive(node, nodeId) {
            if (!node) return null; 
            if (node.id === nodeId) {
                return node;
            }
            if (node.children) {
                for (let child of node.children) {
                    const found = findNodeRecursive(child, nodeId);
                    if (found) return found;
                }
            }
            return null;
        }

        function confirmMove() {
            const newPartnerId = newPartnerSelector.value;
            if (!currentEmployeeToMoveD3Node || !newPartnerId) {
                alert("Please select an employee and a new partner.");
                return;
            }
            
            const employeeToMoveData = currentEmployeeToMoveD3Node.data; 
            const employeeToMoveId = employeeToMoveData.id;

            console.log(`Attempting to move ${employeeToMoveData.name} (ID: ${employeeToMoveId}) to new Partner ID: ${newPartnerId}`);

            const originalCoachId = employeeToMoveData.coach_id;
            let originalCoachNode = null;
            if (originalCoachId) {
                 originalCoachNode = findNodeById(currentGlobalPartnerTrees, originalCoachId);
            }
            
            const newCoachNode = findNodeById(currentGlobalPartnerTrees, newPartnerId);
            const employeeNodeInMemory = findNodeById(currentGlobalPartnerTrees, employeeToMoveId);

            if (!employeeNodeInMemory) {
                console.error("Could not find the employee to move in the current data structure.");
                alert("Error: Could not find the employee to move. Please refresh.");
                moveEmployeeModal.style.display = "none";
                currentEmployeeToMoveD3Node = null;
                return;
            }
            if (!newCoachNode) {
                console.error("Could not find the new coach in the current data structure.");
                alert("Error: Could not find the new coach. Please refresh.");
                moveEmployeeModal.style.display = "none";
                currentEmployeeToMoveD3Node = null;
                return;
            }

            if (isDescendant(employeeNodeInMemory, newCoachNode)) {
                 alert(`Error: Cannot move ${employeeToMoveData.name} under ${newCoachNode.name} as ${newCoachNode.name} is a descendant of ${employeeToMoveData.name}.`);
                 moveEmployeeModal.style.display = "none";
                 currentEmployeeToMoveD3Node = null;
                 return;
            }

            if (originalCoachNode && originalCoachNode.children) {
                const indexInOldCoach = originalCoachNode.children.findIndex(child => child.id === employeeToMoveId);
                if (indexInOldCoach > -1) {
                    originalCoachNode.children.splice(indexInOldCoach, 1);
                }
            } else if (!originalCoachId && employeeNodeInMemory.level !== PARTNER_LEVEL_VALUE) { 
                 console.warn(`Employee ${employeeToMoveId} had no original coach ID but is not a partner, or is a partner being moved.`);
            }

            if (!newCoachNode.children) {
                newCoachNode.children = [];
            }
            if (!newCoachNode.children.find(c => c.id === employeeToMoveId)) {
                newCoachNode.children.push(employeeNodeInMemory);
            }
            
            employeeNodeInMemory.coach_id = newPartnerId;

            if (originalCoachNode) {
                originalCoachNode.direct_coachee_count = originalCoachNode.children ? originalCoachNode.children.length : 0;
            }
            newCoachNode.direct_coachee_count = newCoachNode.children ? newCoachNode.children.length : 0;
            
            currentGlobalPartnerTrees.forEach(root => {
                if (root.level === PARTNER_LEVEL_VALUE) {
                    root.indirect_coachee_count = countAllDescendants(root);
                }
            });
            currentGlobalPartnerTrees.forEach(updateDirectCountsRecursive);

            const logEntry = {
                moved_employee_id: employeeToMoveId,
                moved_employee_name: employeeToMoveData.name,
                original_coach_id: originalCoachId || null, 
                original_coach_name: originalCoachNode ? originalCoachNode.name : "N/A (was a root or no coach)",
                new_coach_id: newPartnerId,
                new_coach_name: newCoachNode.name,
                timestamp: new Date().toISOString()
            };
            changeLog.push(logEntry);

            saveChangeLog();
            renderChangeLogTable();

            const previouslySelectedPartnerIdInDropdown = d3.select("#tree-selector").property("value");
            refreshPartnerSelectorOptions(); 

            let treeToRefreshData = null;
            if (currentRoot) {
                if (currentRoot.data.id === previouslySelectedPartnerIdInDropdown) {
                    treeToRefreshData = findNodeById(currentGlobalPartnerTrees, previouslySelectedPartnerIdInDropdown);
                } else if (newCoachNode.id === currentRoot.data.id) {
                     treeToRefreshData = newCoachNode; 
                } else if (originalCoachNode && originalCoachNode.id === currentRoot.data.id) {
                    treeToRefreshData = findNodeById(currentGlobalPartnerTrees, originalCoachNode.id); // Re-fetch originalCoachNode as its children changed
                }
            } else if (previouslySelectedPartnerIdInDropdown) { 
                 treeToRefreshData = findNodeById(currentGlobalPartnerTrees, previouslySelectedPartnerIdInDropdown);
            }

            if (treeToRefreshData) {
                console.log("Refreshing tree for:", treeToRefreshData.name);
                loadTree(treeToRefreshData); 
            } else {
                if(previouslySelectedPartnerIdInDropdown){ // Ensure selection is maintained even if tree not reloaded
                    d3.select("#tree-selector").property("value", previouslySelectedPartnerIdInDropdown);
                }
                console.log("Move complete. Currently displayed tree not directly affected or no tree displayed.");
            }

            console.log(`Move confirmed for ${employeeToMoveData.name} to partner ${newCoachNode.name}.`);
            moveEmployeeModal.style.display = "none";
            currentEmployeeToMoveD3Node = null;
        }
        
        function isDescendant(ancestorNode, potentialDescendant) {
            if (!ancestorNode || !potentialDescendant) return false;
            if (!ancestorNode.children || ancestorNode.children.length === 0) {
                return false;
            }
            for (let child of ancestorNode.children) {
                if (child.id === potentialDescendant.id) {
                    return true;
                }
                if (isDescendant(child, potentialDescendant)) {
                    return true;
                }
            }
            return false;
        }

        function countAllDescendants(node) {
            let count = 0;
            if (node.children && node.children.length > 0) {
                count += node.children.length; 
                for (let child of node.children) {
                    count += countAllDescendants(child); 
                }
            }
            return count;
        }

        function loadChangeLog() {
            const storedLog = localStorage.getItem(LOCAL_STORAGE_KEY_MOVES);
            if (storedLog) {
                try {
                    changeLog = JSON.parse(storedLog);
                    if (!Array.isArray(changeLog)) changeLog = []; 
                } catch (e) {
                    console.error("Error parsing change log from localStorage:", e);
                    changeLog = [];
                }
            } else {
                changeLog = [];
            }
        }

        function saveChangeLog() {
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY_MOVES, JSON.stringify(changeLog));
            } catch (e) {
                console.error("Error saving change log to localStorage:", e);
                alert("Could not save changes. Local storage might be full.");
            }
        }

        function applyLoggedChanges() {
            if (changeLog.length === 0) return;

            changeLog.forEach(log => {
                const employeeNode = findNodeById(currentGlobalPartnerTrees, log.moved_employee_id);
                const newCoachNode = findNodeById(currentGlobalPartnerTrees, log.new_coach_id);
                let oldCoachNode = null;
                if (log.original_coach_id) { 
                    oldCoachNode = findNodeById(currentGlobalPartnerTrees, log.original_coach_id);
                }

                if (employeeNode && newCoachNode) {
                    if (oldCoachNode && oldCoachNode.children) {
                        const index = oldCoachNode.children.findIndex(child => child.id === employeeNode.id);
                        if (index > -1) {
                            oldCoachNode.children.splice(index, 1);
                        }
                    }
                    
                    if (!newCoachNode.children) newCoachNode.children = [];
                    if (!newCoachNode.children.find(c => c.id === employeeNode.id)) {
                         newCoachNode.children.push(employeeNode);
                    }
                    employeeNode.coach_id = log.new_coach_id; 
                } else {
                    console.warn("Could not apply a logged change during initial load; employee, old coach, or new coach not found:", log);
                }
            });

            currentGlobalPartnerTrees.forEach(root => {
                if (root.level === PARTNER_LEVEL_VALUE) { 
                    root.indirect_coachee_count = countAllDescendants(root);
                }
            });
            currentGlobalPartnerTrees.forEach(updateDirectCountsRecursive); 
        }
        
        function updateDirectCountsRecursive(node) {
             node.direct_coachee_count = node.children ? node.children.length : 0;
            if (node.children) {
                node.children.forEach(updateDirectCountsRecursive);
            }
        }

        function renderChangeLogTable() {
            if (!tempMovesLogTableBody) {
                console.error("tempMovesLogTableBody is not initialized.");
                return;
            }
            tempMovesLogTableBody.innerHTML = ''; 

            if (changeLog.length === 0) {
                const row = tempMovesLogTableBody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 5; 
                cell.textContent = 'No temporary moves recorded.';
                cell.style.textAlign = 'center';
                return;
            }

            const sortedLog = [...changeLog].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            sortedLog.forEach(logEntry => {
                const row = tempMovesLogTableBody.insertRow();
                row.insertCell().textContent = logEntry.moved_employee_name || 'N/A';
                row.insertCell().textContent = logEntry.moved_employee_id;
                row.insertCell().textContent = logEntry.original_coach_name || 'N/A';
                row.insertCell().textContent = logEntry.new_coach_name || 'N/A';
                row.insertCell().textContent = new Date(logEntry.timestamp).toLocaleString();
            });
        }

        function clearTemporaryMoves() {
            if (confirm("Are you sure you want to clear all temporary moves? This cannot be undone and will revert the view to the original data from forest.json.")) {
                changeLog = [];
                saveChangeLog();
                alert("Temporary moves cleared. The page will now reload to reflect the original data.");
                window.location.reload();
            }
        }

        function refreshPartnerSelectorOptions() {
            const selector = d3.select("#tree-selector");
            selector.selectAll("option").each(function() {
                const optionElement = d3.select(this);
                const partnerId = optionElement.attr("value");
                if (partnerId) {
                    const partnerData = findNodeById(currentGlobalPartnerTrees, partnerId);
                    if (partnerData) {
                        const name = partnerData.name || partnerData.id;
                        // Ensure indirect_coachee_count is taken from the live data
                        const indirectCoacheeCount = typeof partnerData.indirect_coachee_count !== 'undefined' ? partnerData.indirect_coachee_count : 'N/A';
                        optionElement.text(`${name} (Pod Size: ${indirectCoacheeCount})`);
                    }
                }
            });
            console.log("Refreshed partner selector options.");
        }
    </script>
</body>
</html>
